---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readr)
CSV_for_ConditionsStandardConditions_YeastStrainWildType_Plate_24423 <- read_csv("~/repo/CurveAnalysis/CSVFiles/CSV_for_ConditionsStandardConditions,YeastStrainWildType_Plate_24423.csv")
current.data<-CSV_for_ConditionsStandardConditions_YeastStrainWildType_Plate_24423
current.data[grep("X",names(current.data))]<-NULL
current.data
log.od<-log(t(as.matrix(current.data[,-1])))
matplot(log.od,type="l")
dim(log.od)
time<-as.numeric(colnames(current.data[-1]))
rates<-apply(log.od,MARGIN = 2,FUN=function(x)diff(x)/diff(time))
matplot(rates,type="l")
plot(rowMeans(rates),type="l")
abline(h=0)
current.data<-as.data.frame(current.data)
colnames(current.data[,-1])<-1:130
#reshape data for lmer
tmp2<-reshape(data=current.data,direction = "long",varying=colnames(current.data[,-1]),v.names ="OD" ,timevar = "Time",times =time)
#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  mod <- lmer(LogOD ~ b1(Time, bp) + b2(Time, bp) + (b1(Time, bp) + b2(Time, bp) | Well), data = tmp2)
  deviance(mod,REML=FALSE)
}


N <- 40 # number of sampled points
K <- 3  # number of knots

piece.formula <- function(var.name, knots) {
  formula.sign <- rep(" - ", length(knots))
  formula.sign[knots < 0] <- " + "
  paste(var.name, "+",
        paste("I(pmax(", var.name, formula.sign, abs(knots), ", 0))",
              collapse = " + ", sep=""))
}
library(lme4)
library(bcp)
plot(bcp(log.od))
knots<-time[c(20,50,100)]
#model <- lmer(formula=formula(paste("log(OD) ~",paste( piece.formula("Time", knots),"+1|Well_Name"))),data = tmp2 )
 rand.slope<-paste("(1+",paste(piece.formula("Time", knots),")|Well_Name"))
model <- lmer(formula=formula(paste("log(OD) ~1+",rand.slope)),data = tmp2 )
```

No with stan

```{r}

time[1]=0
OD<-as.matrix(current.data[,-1])
M <- ceiling(length(time)^(2/3))
#M<-10
N <- 16
K=2
OD<-as.matrix(current.data[1:N,-1])
T<- length(time)
D<-bernstein.derivative.operator(M)

timeN<--1*normalize.interval(time)
X<-bernstein.matrix(M,timeN)

```

```{r}
LAMBDA=1
SIGMA_MU=0.1
MU=c(0.2,0.06)
#MU=c(0,0)
model <- stan_model(file = "BernsteinFit.stan")
fit<-vb(model, output_samples=1000, seed=123)
plotfit(fit)
#save(list="fit",file="fitADVI.RData")
matplot(t(OD),type="l")

```



```{r}
library(rstan)
library(coda)
library(ggmcmc)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
fit<-stan("BernsteinFit.stan",chains=6 )
save(list="fit",file="fit.RData")
plotfit<-function(fit){
tmp<-rstan::extract(fit,"rate")
rate<-tmp$rate

#t2<-t(matrix(colMeans(tmp),N,T))
#matplot(t2,type="l")

rate<-(matrix(colMeans(rate),N,2))
boxplot(rate,main="mean rates")

tmp<-rstan::extract(fit,"sigma_o")
sigma_o<-tmp$sigma_o
hist(sigma_o)
tmp<-rstan::extract(fit,"OD_pred")
ODp<-tmp$OD_pred

ODp<-t(matrix(colMeans(ODp),N,T))
matplot(x = seq(0,1,length.out = T),ODp,type="l")

tmp<-rstan::extract(fit,"rate_pred")
tmp<-tmp$rate_pred

t2<-t(matrix(colMeans(tmp),N,T))
matplot(t2,type="l",main="rate_pred")

#mu<-rstan::extract(fit,"mu")
#mu<-mu$mu
#hist(mu[,1])
#hist(mu[,2])
tau<-rstan::extract(fit,"tau")
tau<-tau$tau
hist(tau[,5])
lambda<- rstan::extract(fit,"lambda")
lambda <- lambda$lambda
hist(lambda)
}
#plot(fit, pars=c("tau"))
#s <- mcmc.list(lapply(1:ncol(fit), function(x) mcmc(as.array(fit)[,x,])))
#S <- ggs(s)
#ggmcmc(S)

```

